name: Laravel CI

on:
    push:
        branches: [ "main" ]
    pull_request:
        branches: [ "main" ]

jobs:
    laravel-tests:
        runs-on: ubuntu-latest

        services:
            mariadb:
                image: 'mariadb:10.11'
                env:
                    MYSQL_ROOT_PASSWORD: password
                    MYSQL_DATABASE: testing
                    MYSQL_USER: root
                    MYSQL_PASSWORD: password
                    MYSQL_ALLOW_EMPTY_PASSWORD: 1
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping -h localhost"
                    --health-start-period=30s
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5

        steps:
            - uses: actions/checkout@v3

            - name: Set up PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.4
                  extensions: mbstring, pdo_mysql, bcmath, intl
                  coverage: none

            - name: Install Composer dependencies
              run: composer install --no-progress --prefer-dist --optimize-autoloader

            - name: Copy .env
              run: cp .env.example .env

            - name: Generate app key
              run: php artisan key:generate

            - name: Wait for MariaDB
              run: |
                  until mysqladmin ping -h 127.0.0.1 -uroot -ppassword --silent; do
                      echo "Waiting for database..."
                      sleep 5
                  done

            - name: Run migrations
              run: php artisan migrate --force

            - name: Run tests
              run: php artisan test